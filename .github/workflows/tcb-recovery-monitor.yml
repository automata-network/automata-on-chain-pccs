name: TCB Recovery Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" 

permissions:
  contents: read
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan deployments against Intel TCB data
        id: scan
        env:
          INTEL_API_URL: https://api.trustedservices.intel.com/tdx/certification/v4/tcbevaluationdatanumbers
        run: |
          chmod +x .github/scripts/tcb_recovery_scan.sh
          .github/scripts/tcb_recovery_scan.sh scan-result.json

          missing_count=$(jq -r '.missing_count' scan-result.json)
          echo "missing_count=$missing_count" >> "$GITHUB_OUTPUT"

      - name: Create or update missing deployment issue
        if: steps.scan.outputs.missing_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const payload = JSON.parse(fs.readFileSync('scan-result.json', 'utf8'))
            const { owner, repo } = context.repo
            const labelName = 'tcb-recovery-missing-deployment'

            async function ensureLabel() {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName })
              } catch {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: 'd93f0b',
                  description: 'Missing versioned DAO deployment(s) detected from Intel TCB recovery data'
                })
              }
            }

            await ensureLabel()

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              labels: labelName,
              per_page: 100
            })

            const existing = openIssues.find((issue) => !issue.pull_request && issue.title.startsWith('Missing Deployment Found'))

            if (existing) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existing.number,
                title: payload.issue_title,
                body: payload.issue_body,
                labels: [labelName]
              })
              core.info(`Updated issue #${existing.number}`)
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title: payload.issue_title,
                body: payload.issue_body,
                labels: [labelName]
              })
              core.info(`Created issue #${created.data.number}`)
            }

      - name: No missing deployments
        if: steps.scan.outputs.missing_count == '0'
        run: echo "No missing deployments found for current early/standard targets."
